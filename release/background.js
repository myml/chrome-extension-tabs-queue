"use strict";function Queue(e){this.window=e,this.name=formatDateTime(Date.now()),this.items=[],this.openingTab=!1}function Item(e,t,n,A,i,o){this.id=e,this.window=t,this.url=n,this.title,this.state=i,this.locked=o}function setLock(e,t,n){var A=getQueue(e).items;A.length>0&&(A[t].locked=n,cleanAndStore())}function moveItemInQueue(e,t,n){getQueue(e).items.move(t,n),cleanAndStore()}function getQueue(e){for(var t=0;t<queues.length;t++)if(queues[t].window!==DEFAULT_ID&&queues[t].window==e)return queues[t];var n=new Queue(e);return queues.push(n),n}function findTabWaiting(e,t){for(var n=0;n<tabsWaiting.length;n++)if(e===tabsWaiting[n].id)return t&&tabsWaiting.splice(n,1),!0;return!1}function findInQueue(e,t){for(var n=0;n<e.length;n++)if(e[n].url===t)return n;return-1}function isInWhitelist(e){for(var t=0;t<whitelist.length;t++)if(whitelist[t].test(e))return!0;return!1}function removeQueue(e){queues.splice(e,1),cleanAndStore()}function clearQueues(){queues=[],cleanAndStore()}function clearSavedQueues(){for(var e=0;e<queues.length;)queues[e].window===DEFAULT_ID?queues.splice(e,1):e++;cleanAndStore()}function clearItems(e){getQueue(e).items=[],cleanAndStore()}function queueTab(e){if(!isInWhitelist(e.url)){new Notification("标签已加入队列"),console.log("Queue tab: "+e.title);saveItem(new Item(e.id,e.windowId,e.url,e.title,e.status,!1)),isQueuing=!0,chrome.tabs.remove(e.id,function(){chrome.runtime.lastError})}}function compareById(e,t){return e.id<t.id?-1:e.id>t.id?1:0}function queueToLimit(e){chrome.tabs.query({windowId:e,pinned:!1},function(e){for(t=0;t<e.length;t++)isInWhitelist(e[t].url)&&(e.splice(t,1),t--);if(e.length>tabLimit){queueByRecent&&(e=e.sort(compareById));for(var t=tabLimit;t<e.length;t++)queueTab(e[t])}})}function saveItem(e){var t=getQueue(e.window).items;if(!allowDuplicates){var n=findInQueue(t,e.url);if(n>=0)return void t.move(n,0)}lifo?t.unshift(e):t.push(e),cleanAndStore(),updateBadgeCounter()}function removeItem(e,t){getQueue(e).items.splice(t,1),cleanAndStore()}function formatDateTime(e){var t=new Date(e);try{e=t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)+" "+("0"+t.getHours()).slice(-2)+":"+("0"+t.getMinutes()).slice(-2)+":"+("0"+t.getSeconds()).slice(-2)}catch(t){e="queue",console.error(t)}return e}function setActive(e){isActive=e,chrome.storage.local.set({isActive:isActive});var t=isActive?ICON_DEFAULT:ICON_DISABLED;isActive?setUpdater():window.clearInterval(updater),chrome.browserAction.setIcon({path:t})}function updateBadgeCounter(){chrome.tabs.query({currentWindow:!0,active:!0},function(e){var t=e[0];if(t){var n="#00ff00",A=getQueue(t.windowId).items;A.length>0&&(n="#ff0000"),chrome.browserAction.setBadgeBackgroundColor({color:n}),chrome.browserAction.setBadgeText({text:A.length.toString(),tabId:t.id})}})}function init(){chrome.storage.local.get(null,function(e){if(void 0===chrome.runtime.lastError){e.hasOwnProperty("tabLimit")&&(tabLimit=e.tabLimit),e.hasOwnProperty("lifo")&&(lifo=e.lifo),e.hasOwnProperty("allowDuplicates")&&(allowDuplicates=e.allowDuplicates),e.hasOwnProperty("queueByRecent")&&(queueByRecent=e.queueByRecent),e.hasOwnProperty("slowNetworkMode")&&(slowNetworkMode=e.slowNetworkMode),e.hasOwnProperty("slowNetworkLimit")&&(slowNetworkLimit=e.slowNetworkLimit),e.hasOwnProperty("isActive")&&(isActive=e.isActive);var t=isActive?ICON_DEFAULT:ICON_DISABLED;chrome.browserAction.setIcon({path:t}),e.hasOwnProperty("queues")&&(queues=JSON.parse(e.queues)),initQueues(),setUpdater(),isActive&&e.hasOwnProperty("restoreOnStart")&&e.restoreOnStart&&restoreSavedQueues(),e.hasOwnProperty("hideContextMenu")&&!e.hideContextMenu&&createContextMenu()}else console.error("An error ocurred initializing options: "+chrome.runtime.lastError.string)})}function initQueues(){if(0!==queues.length)for(var e=0;e<queues.length;e++){var t=queues[e];t.window=DEFAULT_ID;for(var n=0;n<t.items.length;n++)t.items[n].window=DEFAULT_ID}}function setUpdater(){updater=window.setInterval(function(){isActive&&(chrome.windows.getAll({populate:!0},function(e){for(var t=0;t<e.length;t++)"normal"!==e[t].type||checkingItems||(checkingItems=!0,checkOpenNextItems(e[t]),checkingItems=!1)}),updateBadgeCounter())},500)}function calculateFreespace(e){for(var t=0,n=0,A=0;A<e.length;A++)isInWhitelist(e[A].url)||e[A].pinned||(t++,"loading"===e[A].status&&n++);var i=tabLimit-t;if(i>0&&slowNetworkMode){var o=slowNetworkLimit-n;o<i&&(i=o)}return i}function checkOpenNextItems(e){if(0!=e.tabs.length){var t=getQueue(e.id).items,n=calculateFreespace(e.tabs);if(n>0&&t.length>0){var A=0;for(console.log("freeSpace: "+n);n>0&&A<t.length;)t[A].locked?A++:(console.log("create: "+t[A].url),chrome.tabs.create({windowId:e.id,url:t[A].url,active:!1}),removeItem(e.id,A),n--)}}}function openUrlInTab(e,t,n,A,i){isOverriding=A,i?chrome.tabs.update({url:t}):n>-1?chrome.tabs.create({windowId:e,url:t,index:n,active:!1}):chrome.tabs.create({windowId:e,url:t,active:!1})}function openQueueInWindow(e){chrome.windows.create({focused:!1},function(t){e.window=t.id;for(var n=e.items,A=0;A<n.length;A++)n[A].window=t.id})}function restoreQueue(e){queues.length<=e||openQueueInWindow(queues[e])}function restoreSavedQueues(){for(var e=0;e<queues.length;e++)queues[e].window===DEFAULT_ID&&openQueueInWindow(queues[e])}function mergeQueue(e,t){if(!(queues.length<=e)){for(var n=getQueue(t),A=queues[e],i=0;i<A.items.length;i++)n.items.push(A.items[i]);queues.splice(e,1)}}function onSettingsChanged(e,t){var n,A;for(n in e)e.hasOwnProperty(n)&&(A=e[n].newValue,"tabLimit"===n?tabLimit=A:"lifo"===n?lifo=A:"allowDuplicates"===n?allowDuplicates=A:"queueByRecent"===n?queueByRecent=A:"hideContextMenu"===n?A?chrome.contextMenus.removeAll():createContextMenu():"slowNetworkMode"===n?slowNetworkMode=A:"slowNetworkLimit"===n&&(slowNetworkLimit=A))}function cleanAndStore(){if(!storing){storing=!0;var e=window.setTimeout(function(){for(var t=0;t<queues.length;)0===queues[t].items.length?queues.splice(t,1):t++;var n=JSON.stringify(queues);chrome.storage.local.set({queues:n},function(){void 0!==chrome.runtime.lastError&&(console.error("An error ocurred saving queues: "+chrome.runtime.lastError.string),console.error(chrome.runtime.lastError))}),window.clearTimeout(e),storing=!1},2e3)}}function createContextMenu(){chrome.contextMenus.create({id:"context_no_queue",title:"Open link in new tab (don't queue)",contexts:["link"],onclick:onContextMenuLinkClicked}),chrome.contextMenus.create({id:"context_queue",title:"Send link to queue",contexts:["link"],onclick:onContextMenuLinkClicked}),chrome.contextMenus.create({id:"context_tab_queue",title:"Send current tab to queue",contexts:["all"],onclick:onContextMenuLinkClicked})}function onContextMenuLinkClicked(e,t){if("context_no_queue"===e.menuItemId)openUrlInTab(t.windowId,e.linkUrl,t.index+1,!0,!1);else if("context_queue"===e.menuItemId){console.log("Saving Item");saveItem(new Item(DEFAULT_ID,t.windowId,e.linkUrl,t.title,"complete",!1))}else"context_tab_queue"===e.menuItemId&&queueTab(t)}function onCreatedTab(e){isActive&&(isOverriding||tabsWaiting.push(e),isOverriding=!1)}function onUpdatedTab(e,t,n){isActive&&!t.pinned&&findTabWaiting(e,!0)&&chrome.tabs.query({windowId:n.windowId},function(e){calculateFreespace(e)>=0||queueTab(n)})}function onWindowRemoved(e){var t=getQueue(e);t.items.length>0&&(t.name=formatDateTime(Date.now()),t.window=DEFAULT_ID)}function onInstalled(){chrome.storage.local.get(null,function(e){if(e.hasOwnProperty("queueLength")){for(var t=getQueue(DEFAULT_ID),n=["queueLength"],A=0;A<e.queueLength;A++){var i="item"+A,o=new Item(DEFAULT_ID,DEFAULT_ID,e[i],"","complete",!1);n.push(i),t.items.push(o)}chrome.storage.local.remove(n,function(){if(void 0!==chrome.runtime.lastError)return console.error("An error ocurred removing old storage keys: "+chrome.runtime.lastError.string),void console.error(chrome.runtime.lastError)}),cleanAndStore()}})}var DEFAULT_ID=-1,whitelist=[/^chrome[:|-](?!.*suspended\.html).*/,/^https\:\/\/www\.pixiv\.net\/jump\.php.*/],isActive=!0,isQueuing=!1,isOverriding=!1,storing=!1,updater=null,checkingItems=!1,tabsWaiting=[],tabLimit=10,lifo=!1,allowDuplicates=!1,slowNetworkMode=!1,slowNetworkLimit=0,queueByRecent=!1,queues=[],ICON_DEFAULT="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABmJLR0QA/wD/AP+gvaeTAAAAqElEQVR4nO3aQQrCQBBE0Y54/yOrW5GABI0fmfeWs2iKYtLMIjMAAMCKtpm5nzDz2afzT513+XDY31NAHaB23Tl7/ebe+fYO+anlb4AC6gC1vXeAHbASBdQBanvvgKOO7ozSNjO354Plb4AC6gA1BdQBagqoA9QUUAeoKaAOUFNAHaCmgDpATQF1gJoC6gA1BdQBagqoA9TO+Eforyx/AxRQBwAAACg8AEejCFAaFqVwAAAAAElFTkSuQmCC",ICON_DISABLED="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAMAAACdt4HsAAABcVBMVEUAAAD/AAD///8AAAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAAAAAABAAADAAAGAAAKAAAPAAAVAAAcAAAiAAAjAAApAAAtAAA3AABCAABHAABQAABZAABjAABpAAB4AAB6AACHAACQAACbAACkAACxAAC9AAC/AADCAADIAADPAADXAADbAADjAADqAADuAADxAAD1AAD5AAD8AAD+AAD/AAB4L4E0AAAAUXRSTlMAAAABAQMFBgcJCgsMDQ8VFhweICUnKi0uNDY3QkNGTlJUVVhgYmVnaXh5iIuMj52foKGio66wsba5vb7CyMnKzM7W2drb4+bq6/Dz9ff5/P5esCL3AAABx0lEQVR42u3XR1MCQRCGYXoFs6yKGRRzzjlnESOOOeecxTy/Xl3Lni1Bl25ult9xtt7n1oe1aVHuHwgDgMVKm2OjArwB2ZkUBeCZkVL262wgd1J+bMTFBDL88nPjOSwgzSe/1ssB9GHsx1IVIMIM3hfyltKHfXBdGLO9L2Igrhv7h01BBxbasH/aEnRg/hT75x0RAthMCw8cY/+yJxjAocQdCAaw/4r9kWAAuy/YnwhrIGTbz9ifzYd8tQa2HrE/XxB0YOMe+8slQQdWg9jfLItIgG8HNKoOSDdebGox1oBzAHufC+hAvDqgiWygA44O7KfdQAfsjdjP5gMDqMU+UAwMoAr7uUpgABVzCFQBAygKYF8HDMAzi32TnQG4p7HvcAAdyPZj350AdCDdh/2gE+iAPmY+IDrgHFIHlAZ0ILEHe38W0AHTAU25gQ7YW9UBeYAB1KsDKgQGUK0OqBwYQKU0HRADKFEHVAMMoEAdUIOdAZgOqN0BJMDY5gP2F4si4iGwFsT+elnQgZU77G9XBAO4wj64KmiAZixn/OuAMuH3/fS/4Box+sk8YAKaPmAckMYGtOQuGfBqDAAX11KmWQP//41/EngDrVcKealcgDwAAAAASUVORK5CYII=";Array.prototype.move=function(e,t){for(;e<0;)e+=this.length;for(;t<0;)t+=this.length;if(t>=this.length)for(var n=t-this.length;1+n--;)this.push(void 0);return this.splice(t,0,this.splice(e,1)[0]),this},document.addEventListener("DOMContentLoaded",init),chrome.storage.onChanged.addListener(onSettingsChanged),chrome.tabs.onCreated.addListener(onCreatedTab),chrome.tabs.onUpdated.addListener(onUpdatedTab),chrome.windows.onRemoved.addListener(onWindowRemoved),chrome.runtime.onInstalled.addListener(onInstalled);